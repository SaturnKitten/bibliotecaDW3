{% extends "templates/base.html" %}
{% block content %}
  <div x-data="emprestimoForm()">
    <ol class="breadcrumb mb-2">
      <li class="breadcrumb-item active">{{ title }}</li>
    </ol>
    <div class="row">
      <div class="col-12">
        <div class="card-header">{{ title }}</div>
        <div class="card-body">
          <form x-data="emprestimoForm">
            <div class="form-group col-md-6">
              <label for="id_livro" class="form-label">Livro</label>
              <select id="id_livro" name="id_livro" class="form-select" x-model="form.id_livro" {{ 'disabled' if disabled }}>
                <option value="" disabled>Selecione um livro...</option>
                {% for livro in livros %}
                  <option value="{{ livro.id }}">
                    {{ livro.titulo }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-6">
              <label for="id_leitor" class="form-label">Leitor</label>
              <select id="id_leitor" name="id_leitor" class="form-select" x-model="form.id_leitor" {{ 'disabled' if disabled }}>
                <option value="" disabled>Selecione um leitor...</option>
                {% for leitor in leitores %}
                  <option value="{{ leitor.id }}">
                    {{ leitor.nome }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-6">
              <label for="data_emprestimo">Data de Empréstimo</label>
              <input type="date" id="data_emprestimo" class="form-control" x-model="form.data_emprestimo" x-bind:disabled="disabled"></div>
              <div class="form-group col-md-6">
                <label for="data_vencimento">Data de Vencimento</label>
                <input type="date" id="data_vencimento" class="form-control" x-model="form.data_vencimento" x-bind:disabled="disabled"></div>
                <div class="form-group col-md-4">
                  <label for="status" class="form-label">Status</label>
                  <select class="form-select" id="status" name="status" x-model="form.status" {{ 'disabled' if disabled }}>
                    <option value="" disabled>Selecione...</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Devolvido">Devolvido</option>
                    <option value="Atrasado">Atrasado</option>
                  </select>
                  <label for="multa_atraso">Multa por Atraso</label>
                  <input
                    type="number"
                    id="multa_atraso"
                    step="0.01"
                    class="form-control"
                    x-model="form.multa_atraso"
                    x-bind:disabled="disabled"></div>
                  <button type="button" @click="updateForm()" class="btn btn-primary mt-4">Salvar</button>
                  <button type="button" @click="deleteForm()" x-show="!disabled" class="btn btn-danger mt-4">Excluir</button>
                  <a href="/emprestimo/manutEmprestimo" class="btn btn-info mt-4 ml-2">Retornar</a>
                </form>
                <div class="mt-3">
                  <template x-if="message">
                    <div :class="messageClass" x-text="message"></div>
                  </template>
                </div>
              </div>
            </div>
          </div>
        </div>
        <script>
          // 1. Funções que rodam ao carregar a página (JQuery/Vanilla)
          window.onload = function () {
            windowOnLoad();
            const localErro = "{{ erro }}";
            if (localErro != "") {
              alert("[vwFRUDrEmprestimo|onload] Servidor retornou o erro:" + localErro);
            }
            $("#id_livro").focus();
          };
          // 2. Inicialização do Alpine.js
          document.addEventListener('alpine:init', () => { // Define o componente 'emprestimoForm' que você usa no x-data
            Alpine.data('emprestimoForm', () => ({
              form: {
                id: "{{ data.id }}",
                id_livro: "{{ data.id_livro }}", // Garante que o ID venha para o select
                id_leitor: "{{ data.id_leitor }}", // Garante que o ID venha para o select
                data_emprestimo: "{{ data.data_emprestimo }}",
                data_vencimento: "{{ data.data_vencimento }}",
                status: "{{ data.status }}", // Garante que o status venha
                multa_atraso: "{{ data.multa_atraso }}",
                removido: false
              },
              message: '',
              messageClass: '',
              disabled: {{ disabled }}, // Nunjucks injeta true ou false aqui
              async updateForm() {
                try {
                  const response = await fetch('/emprestimo/UpdateEmprestimo', {
                    method: 'POST',
                    headers: {
                      "Content-Type": "application/json"
                    },
                    body: JSON.stringify(this.form)
                  });
                  const result = await response.json();
                  if (result.status == "ok") {
                    alert("Empréstimo atualizado com sucesso");
                    window.location.href = "/emprestimo/manutEmprestimo";
                  } else {
                    this.message = `Erro! ${
                      result.msg
                    }`;
                    this.messageClass = 'alert alert-danger';
                  }
                } catch (error) {
                  this.message = `Erro de conexão: ${
                    error.message
                  }`;
                  this.messageClass = 'alert alert-danger';
                }
              },
              async deleteForm() {
                if (!confirm("Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.")) {
                  return;
                }
                try {
                  this.form.removido = true;
                  const response = await fetch('/emprestimo/DeleteEmprestimo', {
                    method: 'POST',
                    headers: {
                      "Content-Type": "application/json"
                    },
                    body: JSON.stringify(
                    {id: this.form.id})
                  });
                  const result = await response.json();
                  if (result.status == "ok") {
                    alert("Empréstimo removido com sucesso");
                    window.location.href = "/emprestimo/manutEmprestimo";
                  } else {
                    this.message = `Erro! ${
                      result.msg
                    }`;
                    this.messageClass = 'alert alert-danger';
                  }
                } catch (error) {
                  this.message = `Erro de conexão: ${
                    error.message
                  }`;
                  this.messageClass = 'alert alert-danger';
                }
              }
            }));
          });
        </script>
      {% endblock %}